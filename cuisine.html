<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Speedy Swaag</title>
        <meta name="description" content="Cause food deliveries are swaaag !">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
        <link rel="shortcut icon" href="favicon.png">

        <link rel="stylesheet" href="css/style.css">
        <link rel="stylesheet" href="css/normalize.css">
        <link rel="stylesheet" href="css/bootstrap.min.css">
        <script src="js/vendor/modernizr-2.6.2.min.js"></script>
        <script src="js/PeerConnection.js"> </script>
    </head>
    <body>

        <div id="logo">Speedy Swaag</div>

        <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

        <!-- WAITING ORDER WINDOW-->
        <div id="waitingOrderWindow" class="fullscreen hide">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12 center">
                        <h1 class="center">Waiting for order<span class="one">.</span><span class="two">.</span><span class="three">.</span></h1>
                    </div>
                </div>
            </div>
        </div>

        <!-- FAKE ORDER WINDOW-->
        <div id="orderWindow" class="fullscreen">
            <div class="container">
                <div class="row">
                    <div class="col-lg-6" style="height:100%;">
                        <div id="kitchenWindow" class="center">
                            <h1>Kitchen Live !</h1>
                            <div id="kitchen"></div>
                            <button id="start-broadcasting" class="setup btn btn-primary btn-lg" disabled>Broadcast!</button>
                        </div>
                    </div>
                    <div class="col-lg-6 center">
                        <div id="lstChecks">
                            <p><label class="cuisine checked"><input type="checkbox" value="0" />Order Placed</label></p>
                            <p><label class="cuisine"><input type="checkbox" value="0" />Preparation</label></p>
                            <p><label class="cuisine"><input type="checkbox" value="0" />Bake</label></p>
                            <p><label class="cuisine"><input type="checkbox" value="0" class="qc"/>Quality Control</label></p>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-6 col-md-offset-6">
                        <div id="drivers" class="hide center">
                            <h1>Select the driver !</h1>
                            <img src="img/driver1.png" class="img-thumbnail"/>
                            <img id="chewbie" src="img/driver2.jpg" class="img-thumbnail"/>
                            <img src="img/driver3.jpg" class="img-thumbnail"/>
                            <img src="img/driver4.jpg" class="img-thumbnail"/>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VROOM VROOM WINDOW-->
        <div id="vroomVroomWindow" class="fullscreen hide">
            <div class="container">
                <div id="livreur" class="center">
                    <div class="row">
                        <div class="col-lg-12">
                            <h1>Deliver here !</h1>
                            <p><img src="img/mapslivreur.png" class="img-thumbnail"/></p>
                            <p><button id="start-broadcasting" class="setup btn btn-primary btn-lg">
                                <img src="img/customer.jpg" style="height:80px;border-radius:40px;margin-right:16px"/>Call Customer</button></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.10.2.min.js"><\/script>')</script>
        <script src="js/bootstrap.min.js"></script>
        <script src="js/script.js"></script>

         <script>
                //var peer = new PeerConnection('ws://websocket-signaling.jit.su:80');
                var peer = new PeerConnection('ws://192.168.1.130:1338');
                peer.onUserFound = function(userid) {
                    if (document.getElementById(userid)) return;
                    var tr = document.createElement('tr');

                    var td1 = document.createElement('td');
                    var td2 = document.createElement('td');

                    td1.innerHTML = userid + ' has camera. Are you interested in video chat?';

                    var button = document.createElement('button');
                    button.innerHTML = 'Join';
                    button.id = userid;
                    button.style.float = 'right';
                    button.onclick = function() {
                        this.disabled = true;
                        peer.sendParticipationRequest(this.id);
                    };
                    td2.appendChild(button);

                    tr.appendChild(td1);
                    tr.appendChild(td2);
                    roomsList.appendChild(tr);
                };

                peer.onStreamAdded = function(e) {
                    if (e.type == 'local') document.querySelector('#start-broadcasting').disabled = false;
                    if (e.type !== 'local') return;
                    var video = e.mediaElement;

                    video.setAttribute('width', 600);
                    video.setAttribute('controls', false);

                    videosContainer.insertBefore(video, videosContainer.firstChild);

                    video.play();
                    rotateVideo(video);
                    scaleVideos();
                };

                /*
                peer.onStreamEnded = function(e) {
                    var video = e.mediaElement;
                    if (video) {
                        video.style.opacity = 0;
                        rotateVideo(video);
                        setTimeout(function() {
                            video.parentNode.removeChild(video);
                            scaleVideos();
                        }, 1000);
                    }
                };
                */

                document.querySelector('#start-broadcasting').onclick = function() {
                    this.disabled = true;
                    peer.startBroadcasting();
                };


                var videosContainer = document.getElementById('videos-container') || document.body;
                var btnSetupNewRoom = document.getElementById('setup-new-room');
                var roomsList = document.getElementById('rooms-list');

                if (btnSetupNewRoom) btnSetupNewRoom.onclick = setupNewRoomButtonClickHandler;

                function rotateVideo(video) {
                    video.style[navigator.mozGetUserMedia ? 'transform' : '-webkit-transform'] = 'rotate(0deg)';
                    setTimeout(function() {
                        video.style[navigator.mozGetUserMedia ? 'transform' : '-webkit-transform'] = 'rotate(360deg)';
                    }, 1000);
                }

                function scaleVideos() {
                    var videos = document.querySelectorAll('video'),
                        length = videos.length, video;

                    var minus = 130;
                    var windowHeight = 700;
                    var windowWidth = 600;
                    var windowAspectRatio = windowWidth / windowHeight;
                    var videoAspectRatio = 4 / 3;
                    var blockAspectRatio;
                    var tempVideoWidth = 0;
                    var maxVideoWidth = 0;

                    for (var i = length; i > 0; i--) {
                        blockAspectRatio = i * videoAspectRatio / Math.ceil(length / i);
                        if (blockAspectRatio <= windowAspectRatio) {
                            tempVideoWidth = videoAspectRatio * windowHeight / Math.ceil(length / i);
                        } else {
                            tempVideoWidth = windowWidth / i;
                        }
                        if (tempVideoWidth > maxVideoWidth)
                            maxVideoWidth = tempVideoWidth;
                    }
                    for (var i = 0; i < length; i++) {
                        video = videos[i];
                        if (video)
                            video.width = maxVideoWidth - minus;
                    }
                }

                window.onresize = scaleVideos;

            </script>
    </body>
</html>
